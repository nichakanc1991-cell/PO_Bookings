<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PO Grooming ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?ver=3.4.1"></script>
  <script src="js/i18n.js"></script>


  <!-- Day.js -->
  <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/utc.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/timezone.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);
    dayjs.tz.setDefault("Asia/Bangkok");
  </script>

  <style>
    /* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å */
    :root{
      --po-deep:#0b3d36;      /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
      --po-forest:#1c322d;    /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏õ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏° */
      --po-olive:#324f44;     /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏Å‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å */
      --po-olive-dark:#2a3e38;
      --po-card:#f6f9f7;      /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏ó‡∏ô‡∏≠‡πà‡∏≠‡∏ô */
      --po-border:#dbe4df;    /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ô‡∏∏‡πà‡∏° */
      --po-cream:#f8f4e7;     /* ‡∏Ñ‡∏£‡∏µ‡∏°‡πÑ‡∏•‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏•‡πà‡∏≤‡∏á */
    }
    .slot-active{background:#e6efe9;border-color:#93c5b1;color:#1f3933}
    
  #monthTitle { color: #fff !important; }
  .calendar-header div { color: #fff !important; }
    
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-[var(--po-deep)] to-[var(--po-cream)]">
<main class="max-w-6xl mx-auto p-4 md:p-6">

  <!-- Header -->
  <header class="mb-4 md:mb-6 flex items-center justify-between gap-3 bg-white/65 backdrop-blur-md rounded-2xl px-5 py-3 shadow-md border border-[color:var(--po-border)]/70">
    <h1 class="text-2xl md:text-3xl font-extrabold text-[var(--po-forest)] tracking-wide drop-shadow-sm">
  üêæ PO Grooming ‚Äî <span class="text-[var(--po-olive)] font-semibold" data-i18n="title.booking">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</span>
</h1>
    <div class="flex items-center gap-2 text-xs">
      <span id="syncBadge" class="px-2 py-1 rounded bg-gray-100 text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î</span>
      <button id="btnReload" class="px-2 py-1 rounded border border-[color:var(--po-border)] hover:bg-white/60">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <a class="text-indigo-700 hover:underline font-medium" target="_blank"
         href="https://docs.google.com/spreadsheets/d/1xhS3Yl5BpTkTSjEKT_nMM6G7qgCf7-m7vkFZjiWaGmE/edit?gid=0#gid=0">‡πÄ‡∏õ‡∏¥‡∏î Google Sheets</a>
    </div>
  <div class="flex items-center gap-2 text-sm">
     <button onclick="setLang('th')" class="px-2 py-1 rounded hover:bg-white/60">‡πÑ‡∏ó‡∏¢</button>|
     <button onclick="setLang('en')" class="px-2 py-1 rounded hover:bg-white/60">English</button>|
     <button onclick="setLang('zh')" class="px-2 py-1 rounded hover:bg-white/60">‰∏≠Êñá</button>
  </div>

  </header>

  <div class="grid md:grid-cols-[3fr_2fr] gap-6">
    <!-- LEFT -->
    <section class="space-y-4">
      <!-- Calendar Card -->
      <div class="rounded-2xl shadow-md p-4 border border-[color:var(--po-border)] bg-[color:var(--po-card)]/90 backdrop-blur-sm">
        <div class="flex items-center justify-between mb-2">
          <button id="prevMonth" class="p-2 rounded-lg border border-[color:var(--po-border)] hover:bg-white">‚Äπ</button>
          <div id="monthTitle" class="text-lg font-semibold text-[var(--po-forest)]"></div>
          <button id="nextMonth" class="p-2 rounded-lg border border-[color:var(--po-border)] hover:bg-white">‚Ä∫</button>
        </div>

        <div class="grid grid-cols-7 text-center text-xs mb-1 font-medium calendar-header">
  <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
</div>

        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>

        <div class="mt-3 flex flex-wrap gap-3 text-xs text-gray-700">
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span>‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-500 inline-block"></span>‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span>‡πÄ‡∏ï‡πá‡∏°</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-400 inline-block"></span>‡∏õ‡∏¥‡∏î</div>
        </div>

        <!-- Legend note -->
        <div class="mt-3 rounded-xl border border-amber-200 bg-amber-50 text-amber-900 text-xs p-3 leading-relaxed">
          <div class="font-semibold mb-1">‚åõ ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
          <ul class="list-disc pl-5 space-y-0.5">
            <li>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Äî <span class="font-medium">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></li>
            <li>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏±‡∏î‡∏Ç‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Äî <span class="font-medium">2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></li>
            <li>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ç‡∏ô ‚Äî <span class="font-medium">3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></li>
          </ul>
          <div class="mt-2 text-[11px] text-amber-800">
            * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ‚Äú‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‚Äù ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
          </div>
        </div>
      </div>

      <!-- Time slots -->
      <div id="timeBox" class="rounded-2xl border border-[color:var(--po-border)] shadow-sm p-4 bg-white/90 backdrop-blur hidden">
        <div class="text-sm text-[color:var(--po-forest)] mb-2 font-medium">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ <span id="chosenDateLabel" class="font-semibold"></span>
        </div>
        <div id="timeGrid" class="grid grid-cols-3 sm:grid-cols-6 gap-2"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="space-y-4">
      <!-- Steps Card -->
      <div class="rounded-2xl border border-[color:var(--po-border)] shadow-sm p-4 bg-white/80 backdrop-blur">
        <div class="text-sm font-semibold mb-2 text-[var(--po-forest)]" data-i18n="label.steps">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
        <ol class="text-sm space-y-2">
          <li id="step1" class="flex items-start gap-2">
            <span class="w-6 h-6 flex items-center justify-center rounded-full bg-[var(--po-olive)] text-white">1</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤
          </li>
          <li id="step2" class="flex items-start gap-2 text-gray-600">
            <span class="w-6 h-6 flex items-center justify-center rounded-full border">2</span> ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ & ‡πÄ‡∏ö‡∏≠‡∏£‡πå
          </li>
          <li id="step3" class="flex items-start gap-2 text-gray-600">
            <span class="w-6 h-6 flex items-center justify-center rounded-full border">3</span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ï‡∏±‡∏ß)
          </li>
          <li id="step4" class="flex items-start gap-2 text-gray-600">
            <span class="w-6 h-6 flex items-center justify-center rounded-full border">4</span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
          </li>
          <li id="step5" class="flex items-start gap-2 text-gray-600">
            <span class="w-6 h-6 flex items-center justify-center rounded-full border">5</span> ‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥ & ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏•‡∏¥‡∏õ
          </li>
        </ol>
      </div>

      <!-- Step 2 -->
      <div id="formCustomer" class="rounded-2xl border border-[color:var(--po-border)] shadow-sm p-4 bg-white/90 backdrop-blur hidden">
        <div class="text-sm font-semibold mb-2 text-[var(--po-forest)]">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</div>
        <label class="block text-xs text-gray-600 mb-1" data-i18n="label.name">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
        <input id="custName" class="w-full border border-[color:var(--po-border)] rounded-xl p-2 mb-2 focus:outline-none focus:ring-2 focus:ring-[var(--po-olive)]/30" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" />
        <label class="block text-xs text-gray-600 mb-1"data-i18n="label.phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
        <input id="custPhone" class="w-full border border-[color:var(--po-border)] rounded-xl p-2 mb-3 focus:outline-none focus:ring-2 focus:ring-[var(--po-olive)]/30" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08xxxxxxxx" />
        <button id="toPets" class="w-full px-4 py-2 rounded-xl bg-[var(--po-olive)] text-white hover:bg-[var(--po-olive-dark)] transition"data-i18n="label.next">
          ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </button>
      </div>

      <!-- Step 3 -->
      <div id="formPets" class="rounded-2xl border border-[color:var(--po-border)] shadow-sm p-4 bg-white/90 backdrop-blur hidden">
        <div class="text-sm font-semibold mb-2 text-[var(--po-forest)]">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ï‡∏±‡∏ß)</div>
        <div id="petsContainer" class="space-y-4"></div>

        <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏±‡∏ï‡∏ß‡πå -->
        <div class="mt-4 space-y-3 text-center">
          <p class="text-xs text-gray-600">üí∞ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏à‡∏£‡∏¥‡∏á)</p>
          <div id="priceCat" class="hidden">
            <img src="./price-cat.png" alt="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥-‡∏ï‡∏±‡∏î‡∏Ç‡∏ô‡πÅ‡∏°‡∏ß" class="w-full rounded-lg border border-[color:var(--po-border)] shadow-sm object-contain">
          </div>
          <div id="priceDog" class="hidden">
            <img src="./price-dog.png" alt="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥-‡∏ï‡∏±‡∏î‡∏Ç‡∏ô‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" class="w-full rounded-lg border border-[color:var(--po-border)] shadow-sm object-contain">
          </div>
          <div id="optionImage" class="hidden">
            <img src="./option.png" alt="‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" class="w-full rounded-lg border border-[color:var(--po-border)] shadow-sm object-contain">
          </div>
        </div>

        <!-- ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
        <section class="space-y-3 my-4">
          <img src="./warning.png" class="w-full rounded-lg border border-[color:var(--po-border)] object-contain" alt="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç">
        </section>

        <div class="mt-4 flex gap-2">
          <button id="addPet" class="px-3 py-2 rounded-xl border border-[color:var(--po-border)] hover:bg-white text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2/3</button>
          <button id="toTerms" class="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </div>

      <!-- Step 4 -->
      <div id="formTerms" class="rounded-2xl border border-[color:var(--po-border)] shadow-sm p-4 bg-white/90 backdrop-blur hidden">
        <section class="space-y-3 mb-4">
          <img src="./terms-1.png" class="w-full rounded-lg border border-[color:var(--po-border)] object-contain" alt="‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß">
          <img src="./terms-2.png" class="w-full rounded-lg border border-[color:var(--po-border)] object-contain" alt="‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
          <img src="./terms-3.png" class="w-full rounded-lg border border-[color:var(--po-border)] object-contain" alt="‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô">
        </section>
        <label class="flex items-center gap-2 text-sm">
          <input id="agree" type="checkbox" class="w-4 h-4" />
          <span>‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>
        </label>
        <button id="toPayment" class="w-full mt-3 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40" disabled>
          ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        </button>
      </div>

      <!-- Step 5 -->
      <div id="formPay" class="rounded-2xl border border-[color:var(--po-border)] shadow-sm p-4 bg-white/90 backdrop-blur hidden">
        <div class="text-sm font-semibold mb-2 text-[var(--po-forest)]"data-i18n="label.deposit">‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥ 200 ‡∏ö‡∏≤‡∏ó ‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ </div>
        <img id="qrImage" class="w-full rounded-xl border border-[color:var(--po-border)] shadow max-h-[560px] object-contain" src="./qr.png" alt="QR">
        <button id="goLine" class="w-full mt-3 px-4 py-3 rounded-xl bg-green-600 text-white hover:bg-green-700"data-i18n="label.notifyline">
          ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå (‡πÄ‡∏õ‡∏¥‡∏î LINE OA)
        </button>
      </div>
    </section>
  </div>

  <footer class="text-center text-xs text-gray-200/90 mt-8">¬© 2025 PO Grooming</footer>
</main>

<script>
/* ===== CONFIG (‡πÄ‡∏î‡∏¥‡∏°) ===== */
const SHEET_GVIZ_JSON="https://docs.google.com/spreadsheets/d/1xhS3Yl5BpTkTSjEKT_nMM6G7qgCf7-m7vkFZjiWaGmE/gviz/tq?tqx=out:json&gid=0";
const SHEET_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1tTADklx6sJ4rLaiflR2VR4brc8WR38FsEp_M2Bf8hM0V9pBNmOrMJurEqAEfzOgNKbFc-_WuyaXF/pub?gid=0&single=true&output=csv";
const LINE_OA_ID="@po_grooming";

const START_DATE=dayjs.tz("2025-10-01");
const END_DATE=dayjs.tz("2025-12-31");
const TIME_SLOTS=["14:00","15:00","16:00","17:00","18:00","19:00"];

/* ===== STATE (‡πÄ‡∏î‡∏¥‡∏°) ===== */
let visibleMonth=START_DATE.startOf("month");
let selectedDate=null, selectedTime=null;
let availability={};
const pets=[];
const syncBadge=document.getElementById("syncBadge");

/* ===== Helpers (‡πÄ‡∏î‡∏¥‡∏°) ===== */
const buddhistYear=y=>y+543;
const monthTitle = d => {
  const en = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];
  return `${en[d.month()]} ${d.year()}`;
};


/* (‡πÄ‡∏î‡∏¥‡∏°) ‚Äì ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö self-contained: normalizeDate */
function normalizeDate(cell){
  // ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á date object ‡∏Ç‡∏≠‡∏á gviz, timestamp, ‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ
  const raw = (cell && typeof cell==="object" && ("v" in cell || "f" in cell)) ? (cell.f ?? cell.v) : cell;
  if (raw==null) return null;

  // gviz date: Date(2025,9,25)
  if (typeof raw==="string" && /Date\(\d+,\d+,\d+\)/.test(raw)){
    const [y,m,d] = raw.match(/\d+/g).map(Number);
    return dayjs.tz({year:y,month:m,day:d});
  }

  // ISO / YYYY-MM-DD
  if (typeof raw==="string" && /^\d{4}-\d{2}-\d{2}/.test(raw)) return dayjs.tz(raw);

  // DD/MM/YYYY ‡∏´‡∏£‡∏∑‡∏≠ MM/DD/YYYY (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏Å‡∏∞)
  if (typeof raw==="string" && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(raw)){
    const [a,b,y]=raw.split("/").map(Number);
    // ‡πÄ‡∏î‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô D/M/Y
    const d1 = dayjs.tz({year:y,month:b-1,day:a});
    if (d1.isValid()) return d1;
  }

  // timestamp ‡∏´‡∏£‡∏∑‡∏≠ Date
  const d = dayjs.tz(raw);
  return d.isValid()? d : null;
}

/* (‡πÄ‡∏î‡∏¥‡∏°) */
function normalizeTime(cell){
  const raw = (cell && typeof cell==="object" && ("v" in cell || "f" in cell)) ? (cell.f ?? cell.v) : cell;
  if (raw==null) return null;

  if (Array.isArray(raw) && raw.length>=2){
    const hh=String(Number(raw[0])||0).padStart(2,"0");
    const mm=String(Number(raw[1])||0).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  if (typeof raw==="number" && raw>=0 && raw<1){
    const totalMinutes=Math.round(raw*24*60);
    const hh=String(Math.floor(totalMinutes/60)).padStart(2,"0");
    const mm=String(totalMinutes%60).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  let s=String(raw).trim();
  if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)) return s.slice(0,5).padStart(5,"0");
  const ampm=s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
  if (ampm){
    let hh=+ampm[1], mm=ampm[2]; const isPM=/pm/i.test(ampm[3]);
    if (isPM && hh<12) hh+=12; if (!isPM && hh===12) hh=0;
    return String(hh).padStart(2,"0")+":"+mm;
  }
  if (/^\d{1,2}$/.test(s)) return String(+s).padStart(2,"0")+":00";
  return s.slice(0,5);
}

/* (‡πÄ‡∏î‡∏¥‡∏°) */
function mapStatus(val){
  const s=(typeof val==="boolean"?(val?"true":"false"):(val??"")).toString().trim().toLowerCase();
  if(s==="true"||s.includes("‡∏ß‡πà‡∏≤‡∏á")) return "‡∏ß‡πà‡∏≤‡∏á";
  if(s==="false"||s.includes("‡πÄ‡∏ï‡πá‡∏°")) return "‡πÄ‡∏ï‡πá‡∏°";
  if(s.includes("‡∏õ‡∏¥‡∏î")) return "‡∏õ‡∏¥‡∏î";
  if(s.includes("‡∏£‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥") || s.includes("pending")) return "‡∏£‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥";
  return "‡∏ß‡πà‡∏≤‡∏á";
}

/* ===== Rules (‡πÄ‡∏î‡∏¥‡∏°) ===== */
const SERVICE_DURATION = {
  "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß": 1,
  "‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥": 2,
  "‡∏ï‡∏±‡∏î‡∏Ç‡∏ô": 2,
  "‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ç‡∏ô": 3,
};
const ALWAYS_ALLOW_ALL_AT = ["18:00", "19:00"];

function contiguousFreeSlots(dateStr, startTime){
  if (!dateStr || !startTime) return 0;
  const daySlots=availability[dateStr]||{};
  const idx=TIME_SLOTS.indexOf(startTime);
  if (idx<0) return 0;
  let n=0;
  for (let i=idx;i<TIME_SLOTS.length;i++){
    const t=TIME_SLOTS[i];
    const v=(daySlots[t]??"‡∏ß‡πà‡∏≤‡∏á");
    if (v==="‡πÄ‡∏ï‡πá‡∏°"||v==="‡∏õ‡∏¥‡∏î") break;
    n++;
  }
  return n;
}
function canBookService(serviceName, dateStr, startTime){
  if (ALWAYS_ALLOW_ALL_AT.includes(startTime)) return true;
  const need=SERVICE_DURATION[serviceName]??0;
  const free=contiguousFreeSlots(dateStr,startTime);
  return free>=need;
}
function updateServiceOptions(){
  const dateStr=selectedDate, startTime=selectedTime;
  const allowAll=!dateStr||!startTime||ALWAYS_ALLOW_ALL_AT.includes(startTime);
  pets.forEach(wrap=>{
    const select=wrap.querySelector('[data-role="service"]'); if(!select) return;
    [...select.options].forEach(opt=>{
      const label=opt.value.trim(); if(!label) return;
      opt.disabled = allowAll ? false : !canBookService(label,dateStr,startTime);
    });
    const cur=select.value.trim();
    if(cur && select.querySelector(`option[value="${cur}"]`)?.disabled){ select.value=""; }
    select.title = allowAll ? "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ä‡∏ô‡∏¥‡∏î" : "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
  });
}

/* ===== Parsers (‡πÄ‡∏î‡∏¥‡∏°) ===== */
function parseGviz(text){
  const obj=JSON.parse(text.substring(text.indexOf("{"),text.lastIndexOf("}")+1));
  const cols=obj.table.cols||[];
  const labels=cols.map(c=>(c.label||"").toLowerCase());
  const types=cols.map(c=>(c.type||"").toLowerCase());
  let dateIdx=labels.indexOf("date");
  let timeIdx=labels.indexOf("time");
  let statusIdx=labels.indexOf("status");
  if(dateIdx===-1) dateIdx=types.indexOf("date");
  if(timeIdx===-1) timeIdx=types.indexOf("timeofday");
  if(timeIdx===-1) timeIdx=(dateIdx!==1?1:0);
  if(statusIdx===-1) statusIdx=[0,1,2].find(i=>i!==dateIdx&&i!==timeIdx)??2;
  if(dateIdx<0||timeIdx<0||statusIdx<0){console.error("Resolve GViz columns failed",{labels,types});return {};}
  const out={};
  for(const r of (obj.table.rows||[])){
    const c=r.c||[];
    const d=normalizeDate(c[dateIdx]); const t=normalizeTime(c[timeIdx]); const s=c[statusIdx]?.v??c[statusIdx]?.f??"";
    if(!d||!d.isValid?.()||!t) continue;
    const key=d.format("YYYY-MM-DD"); if(!out[key]) out[key]={}; out[key][t]=mapStatus(s);
  }
  return out;
}
function parseCsv(text){
  const lines=text.replace(/\r/g,"").split("\n").filter(Boolean);
  const header=lines[0].split(",").map(s=>s.trim().toLowerCase());
  const iD=header.indexOf("date"), iT=header.indexOf("time"), iS=header.indexOf("status");
  const out={};
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(",").map(s=>s.trim());
    const dRaw=cols[iD], tRaw=cols[iT], s=cols[iS]; if(!dRaw||!tRaw) continue;
    let d=null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(dRaw)) d=dayjs.tz(dRaw);
    else if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dRaw)){const[m,dd,y]=dRaw.split("/").map(Number); d=dayjs.tz({year:y,month:m-1,day:dd});}
    else d=dayjs.tz(dRaw);
    if(!d||!d.isValid()) continue;
    const key=d.format("YYYY-MM-DD");
    const t=normalizeTime(tRaw); if(!t) continue;
    if(!out[key]) out[key]={}; out[key][t]=mapStatus(s);
  }
  return out;
}

/* ===== Fetch Sheet (‡πÄ‡∏î‡∏¥‡∏°) ===== */
async function fetchSheet(){
  syncBadge.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶"; syncBadge.className="px-2 py-1 rounded bg-yellow-100 text-yellow-800";
  try{
    const r=await fetch(SHEET_GVIZ_JSON+"&ts="+Date.now(),{cache:"no-store"});
    if(!r.ok) throw new Error("GVIZ "+r.status);
    availability=parseGviz(await r.text());
    syncBadge.textContent="‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (gviz) "+dayjs().format("HH:mm");
    syncBadge.className="px-2 py-1 rounded bg-green-100 text-green-800";
  }catch(e1){
    console.warn("GVIZ fail ‚Üí CSV",e1);
    try{
      const r2=await fetch(SHEET_CSV_URL+"&ts="+Date.now(),{cache:"no-store"});
      if(!r2.ok) throw new Error("CSV "+r2.status);
      availability=parseCsv(await r2.text());
      syncBadge.textContent="‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (csv) "+dayjs().format("HH:mm");
      syncBadge.className="px-2 py-1 rounded bg-green-100 text-green-800";
    }catch(e2){
      console.error("‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ï‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:",e2);
      syncBadge.textContent="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      syncBadge.className="px-2 py-1 rounded bg-red-100 text-red-800";
      availability={};
    }
  }
}

/* ===== UI Calendar (‡πÄ‡∏î‡∏¥‡∏°) ===== */
function getDayStatus(dateStr){
  const daySlots=availability[dateStr]||{};
  let free=0, full=0, pending=0, closed=false;
  for(const t of TIME_SLOTS){
    const v=(daySlots[t]??"‡∏ß‡πà‡∏≤‡∏á");
    if(v==="‡∏õ‡∏¥‡∏î"){closed=true;break;}
    if(v==="‡πÄ‡∏ï‡πá‡∏°") full++;
    else if(v==="‡∏£‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥") pending++;
    else free++;
  }
  if(closed) return "gray";
  if(free===0 && pending>0) return "yellow";
  if(free===0) return "red";
  if(full===0 && pending===0) return "green";
  return "yellow";
}
function renderCalendar(){
  document.getElementById("monthTitle").textContent=monthTitle(visibleMonth);
  const start=visibleMonth.startOf("month").startOf("week");
  const end=visibleMonth.endOf("month").endOf("week");
  const grid=document.getElementById("calendarGrid"); grid.innerHTML="";
  let d=start.clone();
  while(d.isBefore(end)||d.isSame(end,"day")){
    const dateStr=d.format("YYYY-MM-DD");
    const inRange=d.isAfter(START_DATE.subtract(1,"day"))&&d.isBefore(END_DATE.add(1,"day"));
    const isCurMonth=d.month()===visibleMonth.month();
    const status=inRange?getDayStatus(dateStr):"gray";
    const btn=document.createElement("button");
    btn.type="button"; btn.disabled=!inRange||status==="gray";
    btn.className="aspect-square rounded-xl border border-[color:var(--po-border)] text-sm flex flex-col items-center justify-center gap-1 "+
      (dateStr===selectedDate?"bg-indigo-50 border-indigo-300":"bg-white hover:bg-gray-50")+
      (!isCurMonth?" opacity-50":"")+(!inRange||status==="gray"?" opacity-40 cursor-not-allowed":"");
    btn.innerHTML=`<div class="leading-none">${d.date()}</div>
      <span class="inline-block w-2.5 h-2.5 rounded-full ${status==='green'?'bg-green-500':status==='yellow'?'bg-yellow-500':status==='red'?'bg-red-500':'bg-gray-400'}"></span>`;
    btn.addEventListener("click",()=>{ if(btn.disabled) return; selectedDate=dateStr; selectedTime=null; showTimes(); renderCalendar(); updateStep(2);});
    grid.appendChild(btn);
    d=d.add(1,"day");
  }
}
function showTimes(){
  const box=document.getElementById("timeBox");
  if(!selectedDate){ box.classList.add("hidden"); return; }
  box.classList.remove("hidden");
  document.getElementById("chosenDateLabel").textContent=`(‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayjs(selectedDate).format("DD/MM")}/${buddhistYear(dayjs(selectedDate).year())})`;
  const grid=document.getElementById("timeGrid"); grid.innerHTML="";
  const daySlots=availability[selectedDate]||{};
  TIME_SLOTS.forEach(t=>{
    const v=(daySlots[t]??"‡∏ß‡πà‡∏≤‡∏á");
    const taken=(v==="‡πÄ‡∏ï‡πá‡∏°")||(v==="‡∏õ‡∏¥‡∏î");
    const isPending=(v==="‡∏£‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥");

    const btn=document.createElement("button");
    btn.type="button";
    btn.textContent=t;
    btn.disabled=taken || isPending;
    btn.className="py-3 rounded-xl border border-[color:var(--po-border)] text-sm font-medium "+
      (taken?"bg-gray-100 text-gray-400 cursor-not-allowed":
       isPending?"bg-yellow-100 text-yellow-700 cursor-wait":
       "bg-white hover:bg-[var(--po-card)]");
    btn.addEventListener("click",()=>{[...grid.children].forEach(el=>el.classList.remove("slot-active")); btn.classList.add("slot-active"); selectedTime=t; updateStep(2); updateServiceOptions();});
    grid.appendChild(btn);
  });
}

/* ===== Steps & actions (‡πÄ‡∏î‡∏¥‡∏°) ===== */
function updateStep(step){
  for(let i=1;i<=5;i++){
    const li=document.getElementById(`step${i}`);
    if(i<step) li.className="flex items-start gap-2 text-green-700";
    else if(i===step) li.className="flex items-start gap-2";
    else li.className="flex items-start gap-2 text-gray-600";
  }
  document.getElementById("formCustomer").classList.toggle("hidden",step!==2);
  document.getElementById("formPets").classList.toggle("hidden",step!==3);
  document.getElementById("formTerms").classList.toggle("hidden",step!==4);
  document.getElementById("formPay").classList.toggle("hidden",step!==5);
}
document.getElementById("toPets").addEventListener("click",()=>{
  const name=document.getElementById("custName").value.trim();
  const phone=document.getElementById("custPhone").value.trim();
  if(!selectedDate||!selectedTime) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å");
  if(!name||!phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
  if(pets.length===0) addPetForm();
  updateStep(3);
  updateServiceOptions();
});
document.getElementById("addPet").addEventListener("click",()=>{
  if(pets.length>=3) return alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ï‡∏±‡∏ß");
  addPetForm();
});
function addPetForm(){
  const idx=pets.length+1;
  const wrap=document.createElement("div");
  wrap.className="p-3 border border-[color:var(--po-border)] rounded-xl";
  wrap.innerHTML=`
    <div class="text-sm font-medium mb-2 text-[var(--po-forest)]">‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà ${idx}</div>
    <div class="grid gap-2">
      <label class="text-xs text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á *</label>
      <input class="border border-[color:var(--po-border)] rounded-xl p-2" data-role="petName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏∏‡πã‡∏á‡∏≠‡∏∏‡πã‡∏á" />
      <label class="text-xs text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label>
      <select class="border border-[color:var(--po-border)] rounded-xl p-2" data-role="petType">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
        <option>‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option><option>‡πÅ‡∏°‡∏ß</option><option>‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>
      <label class="text-xs text-gray-600">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
      <input class="border border-[color:var(--po-border)] rounded-xl p-2" data-role="breed" placeholder="‡πÄ‡∏ä‡πà‡∏ô Poodle / Scottish Fold" />
      <label class="text-xs text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ *</label>
      <select class="border border-[color:var(--po-border)] rounded-xl p-2" data-role="service">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
        <option>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥</option><option>‡∏ï‡∏±‡∏î‡∏Ç‡∏ô</option><option>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ç‡∏ô</option><option>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
      </select>
      <label class="text-xs text-gray-600">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
      <textarea class="border border-[color:var(--po-border)] rounded-xl p-2 min-h-[60px]" data-role="addon" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏Ç‡∏ô ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏π ‡∏Ø‡∏•‡∏Ø"></textarea>
      <label class="text-xs text-gray-600">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á</label>
      <textarea class="border border-[color:var(--po-border)] rounded-xl p-2 min-h-[70px]" data-role="notes" placeholder="‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏£‡∏≤‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡πâ‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏ß ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß ‡∏Ø‡∏•‡∏Ø"></textarea>
    </div>`;
  document.getElementById("petsContainer").appendChild(wrap);
  pets.push(wrap); updateServiceOptions();
}
document.getElementById("toTerms").addEventListener("click",()=>{
  if(pets.length===0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß");
  let ok=false;
  for(const wrap of pets){
    const petName=wrap.querySelector('[data-role="petName"]').value.trim();
    const petType=wrap.querySelector('[data-role="petType"]').value.trim();
    const service=wrap.querySelector('[data-role="service"]').value.trim();
    if(!petName && !petType && !service) continue;
    if(!petName || !petType || !service) return alert("‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß");
    ok=true;
  }
  if(!ok) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß");

  /* ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á 3 ‡∏ï‡∏±‡∏ß (‡πÄ‡∏î‡∏¥‡∏°) */
  if (pets.length === 3) {
    const currentTimeIndex = TIME_SLOTS.indexOf(selectedTime);
    if (currentTimeIndex !== -1 && currentTimeIndex + 1 < TIME_SLOTS.length) {
      const extendedSlot = TIME_SLOTS[currentTimeIndex + 1];
      if (availability[selectedDate]) availability[selectedDate][extendedSlot] = "‡πÄ‡∏ï‡πá‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)";
    }
  }
  updateStep(4);
});
document.getElementById("agree").addEventListener("change",e=>{
  document.getElementById("toPayment").disabled=!e.target.checked;
});
document.getElementById("toPayment").addEventListener("click",()=>{
  updateStep(5);
  const dateKey=selectedDate, timeKey=selectedTime;
  if (!availability[dateKey]) availability[dateKey]={};
  availability[dateKey][timeKey]="‡∏£‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥";
  renderCalendar(); showTimes();
  setTimeout(()=>{
    if (availability[dateKey][timeKey]==="‡∏£‡∏≠‡∏°‡∏±‡∏î‡∏à‡∏≥"){
      availability[dateKey][timeKey]="‡∏ß‡πà‡∏≤‡∏á";
      renderCalendar(); showTimes();
    }
  }, 15*60*1000);
});

/* LINE OA deeplink + ‡∏™‡πà‡∏á Google Script */
document.getElementById("goLine").addEventListener("click", async () => {
  const name = document.getElementById("custName").value.trim();
  const phone = document.getElementById("custPhone").value.trim();
  if (!selectedDate || !selectedTime) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤");
  if (!name || !phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2");

  // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏á‡πÜ
  const petLines = pets.map(wrap => {
    const n = wrap.querySelector('[data-role="petName"]').value.trim();
    const t = wrap.querySelector('[data-role="petType"]').value.trim();
    const s = wrap.querySelector('[data-role="service"]').value.trim();
    return `${n || "-"} / ${t || "-"} / ${s || "-"}`;
  }).filter(Boolean);

  const dateLabel = `${dayjs(selectedDate).format("DD/MM")}/${buddhistYear(dayjs(selectedDate).year())}`;
  const msg = [
    "üìå ‡πÅ‡∏à‡πâ‡∏á‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö",
    `‚Ä¢ ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: ${dateLabel} ‡πÄ‡∏ß‡∏•‡∏≤ ${selectedTime} ‡∏ô.`,
    `‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${name}`,
    `‚Ä¢ ‡πÇ‡∏ó‡∏£: ${phone}`,
    `‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á:\n   - ${petLines.join("\n   - ")}`,
    "‚Äî ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß PO Grooming ‚Äî"
  ].join("\n");

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î LINE OA
  const url = `https://line.me/R/oaMessage/${encodeURIComponent(LINE_OA_ID)}/?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");

  // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Apps Script
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbxYRWhaDnfPIXDKh6DO49R48IY44CpwGoVF_mLBq-8geG7t_kfiquXL2Yaggics4eTz/exec", {
      method: "POST",
      body: JSON.stringify({
        type: "calendar",
        date: selectedDate,
        time: selectedTime,
        name,
        phone,
        pet: petLines.join(", ")
      }),
      headers: { "Content-Type": "application/json" }
    });
    console.log(await res.json());
  } catch (err) {
    console.error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Script ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);
  }
});


/* Nav & boot (‡πÄ‡∏î‡∏¥‡∏°) */
document.getElementById("prevMonth").addEventListener("click",()=>{const prev=visibleMonth.subtract(1,"month"); if(prev.isBefore(START_DATE,"month"))return; visibleMonth=prev; renderCalendar();});
document.getElementById("nextMonth").addEventListener("click",()=>{const next=visibleMonth.add(1,"month"); if(next.isAfter(END_DATE,"month"))return; visibleMonth=next; renderCalendar();});
document.getElementById("btnReload").addEventListener("click",async()=>{await fetchSheet(); renderCalendar(); if(selectedDate) showTimes();});

(async function init(){ await fetchSheet(); renderCalendar(); })();

  // ===== ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏≤‡∏Å query string =====
(function(){
  const urlParams = new URLSearchParams(window.location.search);
  const langParam = urlParams.get("lang");
  if (langParam) {
    localStorage.setItem("lang", langParam);
    setLang(langParam);
  } else {
    const savedLang = localStorage.getItem("lang") || "th";
    setLang(savedLang);
  }
})();

</script>
</body>
</html>
