<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PO Grooming ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/utc.js"></script>
  <script src="https://unpkg.com/dayjs@1/plugin/timezone.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);
    dayjs.tz.setDefault("Asia/Bangkok");
  </script>
  <style>.slot-active{background:#909c83;color:#fff;border-color:#4f46e5}</style>
</head>
<body class="min-h-screen bg-gradient-to-b from-indigo-50 to-white">
<main class="max-w-6xl mx-auto p-4 md:p-6">

  <header class="mb-4 md:mb-6 flex items-center justify-between gap-3">
    <h1 class="text-xl md:text-2xl font-bold">PO Grooming ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</h1>
    <div class="flex items-center gap-2 text-xs">
      <span id="syncBadge" class="px-2 py-1 rounded bg-gray-100 text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î</span>
      <button id="btnReload" class="px-2 py-1 rounded border hover:bg-gray-50">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <a class="text-indigo-600 hover:underline" target="_blank"
         href="https://docs.google.com/spreadsheets/d/1xhS3Yl5BpTkTSjEKT_nMM6G7qgCf7-m7vkFZjiWaGmE/edit?gid=0#gid=0">‡πÄ‡∏õ‡∏¥‡∏î Google Sheets</a>
    </div>
  </header>

  <div class="grid md:grid-cols-[3fr_2fr] gap-6">
    <!-- LEFT -->
    <section class="space-y-4">
      <div class="bg-white rounded-2xl border shadow-sm p-4">
        <div class="flex items-center justify-between mb-2">
          <button id="prevMonth" class="p-2 rounded-lg border hover:bg-gray-50">‚Äπ</button>
          <div id="monthTitle" class="text-lg font-semibold"></div>
          <button id="nextMonth" class="p-2 rounded-lg border hover:bg-gray-50">‚Ä∫</button>
        </div>
        <div class="grid grid-cols-7 text-center text-xs text-gray-600 mb-1">
          <div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
        <div class="mt-3 flex gap-3 text-xs text-gray-600">
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span>‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-500 inline-block"></span>‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span>‡πÄ‡∏ï‡πá‡∏°</div>
          <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-400 inline-block"></span>‡∏õ‡∏¥‡∏î</div>
        </div>
      </div>
<!-- ‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å legend ‡πÉ‡∏ï‡πâ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) -->
<div class="mt-3 rounded-xl border bg-amber-50 text-amber-900 text-xs p-3 leading-relaxed">
  <div class="font-semibold mb-1">‚åõ ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
  <ul class="list-disc pl-5 space-y-0.5">
    <li>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Äî <span class="font-medium">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></li>
    <li>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏±‡∏î‡∏Ç‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Äî <span class="font-medium">2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></li>
    <li>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ç‡∏ô ‚Äî <span class="font-medium">3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></li>
  </ul>
  <div class="mt-2 text-[11px] text-amber-800">
    * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ‚Äú‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‚Äù ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  </div>
</div>

      <div id="timeBox" class="bg-white rounded-2xl border shadow-sm p-4 hidden">
        <div class="text-sm text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
          <span id="chosenDateLabel" class="font-semibold"></span>
        </div>
        <div id="timeGrid" class="grid grid-cols-3 sm:grid-cols-6 gap-2"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="space-y-4">
      <div class="bg-white rounded-2xl border shadow-sm p-4">
        <div class="text-sm font-semibold mb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</div>
        <ol class="text-sm space-y-2">
          <li id="step1" class="flex items-start gap-2"><span class="w-6 h-6 flex items-center justify-center rounded-full bg-indigo-600 text-white">1</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</li>
          <li id="step2" class="flex items-start gap-2 text-gray-600"><span class="w-6 h-6 flex items-center justify-center rounded-full border">2</span> ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ & ‡πÄ‡∏ö‡∏≠‡∏£‡πå</li>
          <li id="step3" class="flex items-start gap-2 text-gray-600"><span class="w-6 h-6 flex items-center justify-center rounded-full border">3</span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ï‡∏±‡∏ß)</li>
          <li id="step4" class="flex items-start gap-2 text-gray-600"><span class="w-6 h-6 flex items-center justify-center rounded-full border">4</span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</li>
          <li id="step5" class="flex items-start gap-2 text-gray-600"><span class="w-6 h-6 flex items-center justify-center rounded-full border">5</span> ‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥ & ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏•‡∏¥‡∏õ</li>
        </ol>
      </div>

      <!-- Step 2 -->
      <div id="formCustomer" class="bg-white rounded-2xl border shadow-sm p-4 hidden">
        <div class="text-sm font-semibold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</div>
        <label class="block text-xs text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
        <input id="custName" class="w-full border rounded-xl p-2 mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" />
        <label class="block text-xs text-gray-600 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
        <input id="custPhone" class="w-full border rounded-xl p-2 mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08xxxxxxxx" />
        <button id="toPets" class="w-full px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>

      <!-- Step 3 -->
      <div id="formPets" class="bg-white rounded-2xl border shadow-sm p-4 hidden">
        <div class="text-sm font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ï‡∏±‡∏ß)</div>
        <div id="petsContainer" class="space-y-4"></div>
        <section class="space-y-3 mb-4">
          <img src="./warning.png" class="w-full rounded-lg border object-contain" alt="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç">
        </section>
        <div class="mt-4 flex gap-2">
          <button id="addPet" class="px-3 py-2 rounded-xl border hover:bg-gray-50 text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2/3</button>
          <button id="toTerms" class="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </div>

      <!-- Step 4 -->
      <div id="formTerms" class="bg-white rounded-2xl border shadow-sm p-4 hidden">
        <section class="space-y-3 mb-4">
          <img src="./terms-1.png" class="w-full rounded-lg border object-contain" alt="‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß">
          <img src="./terms-2.png" class="w-full rounded-lg border object-contain" alt="‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">
          <img src="./terms-3.png" class="w-full rounded-lg border object-contain" alt="‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô">
        </section>
        <label class="flex items-center gap-2 text-sm">
          <input id="agree" type="checkbox" class="w-4 h-4" />
          <span>‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>
        </label>
        <button id="toPayment" class="w-full mt-3 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40" disabled>
          ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        </button>
      </div>

      <!-- Step 5 -->
      <div id="formPay" class="bg-white rounded-2xl border shadow-sm p-4 hidden">
        <div class="text-sm font-semibold mb-2">‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥ 200 ‡∏ö‡∏≤‡∏ó</div>
        <img id="qrImage" class="w-full rounded-xl border shadow max-h-[560px] object-contain" src="./qr.png" alt="QR">
        <button id="goLine" class="w-full mt-3 px-4 py-3 rounded-xl bg-green-600 text-white hover:bg-green-700">
          ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå (‡πÄ‡∏õ‡∏¥‡∏î LINE OA)
        </button>
      </div>
    </section>
  </div>

  <footer class="text-center text-xs text-gray-500 mt-8">¬© 2025 PO Grooming</footer>
</main>

<script>
/* ===== CONFIG ===== */
const SHEET_GVIZ_JSON="https://docs.google.com/spreadsheets/d/1xhS3Yl5BpTkTSjEKT_nMM6G7qgCf7-m7vkFZjiWaGmE/gviz/tq?tqx=out:json&gid=0";
const SHEET_CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1tTADklx6sJ4rLaiflR2VR4brc8WR38FsEp_M2Bf8hM0V9pBNmOrMJurEqAEfzOgNKbFc-_WuyaXF/pub?gid=0&single=true&output=csv";
const LINE_OA_ID="@po_grooming";

const START_DATE=dayjs.tz("2025-09-01");
const END_DATE=dayjs.tz("2025-12-31");
const TIME_SLOTS=["14:00","15:00","16:00","17:00","18:00","19:00"];

/* ===== STATE ===== */
let visibleMonth=START_DATE.startOf("month");
let selectedDate=null, selectedTime=null;
let availability={};
const pets=[];
const syncBadge=document.getElementById("syncBadge");

/* ===== Helpers ===== */
const buddhistYear=y=>y+543;
const monthTitle=d=>{
  const th=["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
  return `${th[d.month()]} ${buddhistYear(d.year())}`;
};


// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
function normalizeTime(cell) {
  // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ v/f ‡∏ñ‡πâ‡∏≤ cell ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á gviz
  const raw = (cell && typeof cell === "object" && ("v" in cell || "f" in cell))
    ? (cell.f ?? cell.v)   // ‚ö†Ô∏è ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö 'f' ‡∏Å‡πà‡∏≠‡∏ô (‡∏ö‡∏≤‡∏á‡∏ó‡∏µ gviz ‡πÉ‡∏´‡πâ "2:00 PM")
    : cell;

  if (raw == null) return null;

  // 1) ‡∏Å‡∏£‡∏ì‡∏µ gviz timeofday: [hh, mm, ss, (optional ms)]
  if (Array.isArray(raw) && raw.length >= 2) {
    const hh = String(Number(raw[0]) || 0).padStart(2, "0");
    const mm = String(Number(raw[1]) || 0).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  // 2) ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç fraction-of-day (‡πÄ‡∏ä‡πà‡∏ô 0.5 = 12:00)
  if (typeof raw === "number" && raw >= 0 && raw < 1) {
    const totalMinutes = Math.round(raw * 24 * 60);
    const hh = String(Math.floor(totalMinutes / 60)).padStart(2, "0");
    const mm = String(totalMinutes % 60).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  // 3) ‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  let s = String(raw).trim();

  // HH:mm ‡∏´‡∏£‡∏∑‡∏≠ HH:mm:ss
  if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)) return s.slice(0,5).padStart(5,"0");

  // 2:00 PM / 2:00AM
  const ampm = s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
  if (ampm) {
    let hh = +ampm[1], mm = ampm[2];
    const isPM = /pm/i.test(ampm[3]);
    if (isPM && hh < 12) hh += 12;
    if (!isPM && hh === 12) hh = 0;
    return String(hh).padStart(2,"0") + ":" + mm;
  }

  // "14" -> "14:00"
  if (/^\d{1,2}$/.test(s)) return String(+s).padStart(2,"0") + ":00";

  // fallback (‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
  return s.slice(0,5);
}

function mapStatus(val){
  const s=(typeof val==="boolean"?(val?"true":"false"):(val??"")).toString().trim().toLowerCase();
  if(s==="true"||s.includes("‡∏ß‡πà‡∏≤‡∏á")) return "‡∏ß‡πà‡∏≤‡∏á";
  if(s==="false"||s.includes("‡πÄ‡∏ï‡πá‡∏°")) return "‡πÄ‡∏ï‡πá‡∏°";
  if(s.includes("‡∏õ‡∏¥‡∏î")) return "‡∏õ‡∏¥‡∏î";
  return "‡∏ß‡πà‡∏≤‡∏á";
}

/* ===== Parsers ===== */
function parseGviz(text){
  const obj=JSON.parse(text.substring(text.indexOf("{"),text.lastIndexOf("}")+1));
  const cols=obj.table.cols||[];
  const labels=cols.map(c=>(c.label||"").toLowerCase());
  const types=cols.map(c=>(c.type||"").toLowerCase());
  let dateIdx=labels.indexOf("date");
  let timeIdx=labels.indexOf("time");
  let statusIdx=labels.indexOf("status");
  if(dateIdx===-1) dateIdx=types.indexOf("date");
  if(timeIdx===-1) timeIdx=types.indexOf("timeofday");
  if(timeIdx===-1) timeIdx=(dateIdx!==1?1:0);
  if(statusIdx===-1) statusIdx=[0,1,2].find(i=>i!==dateIdx&&i!==timeIdx)??2;
  if(dateIdx<0||timeIdx<0||statusIdx<0){console.error("Resolve GViz columns failed", {labels,types});return {};}
  const out={};
  for(const r of (obj.table.rows||[])){
    const c=r.c||[];
    const d=normalizeDate(c[dateIdx]); const t=normalizeTime(c[timeIdx]); const s=c[statusIdx]?.v??c[statusIdx]?.f??"";
    if(!d||!d.isValid?.()||!t) continue;
    const key=d.format("YYYY-MM-DD"); if(!out[key]) out[key]={}; out[key][t]=mapStatus(s);
  }
  return out;
}
function parseCsv(text){
  const lines=text.replace(/\r/g,"").split("\n").filter(Boolean);
  const header=lines[0].split(",").map(s=>s.trim().toLowerCase());
  const iD=header.indexOf("date"), iT=header.indexOf("time"), iS=header.indexOf("status");
  const out={};
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(",").map(s=>s.trim());
    const dRaw=cols[iD], tRaw=cols[iT], s=cols[iS]; if(!dRaw||!tRaw) continue;
    let d=null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(dRaw)) d=dayjs.tz(dRaw);
    else if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dRaw)){const[m,dd,y]=dRaw.split("/").map(Number); d=dayjs.tz({year:y,month:m-1,day:dd});}
    else d=dayjs.tz(dRaw);
    if(!d||!d.isValid()) continue;
    const key=d.format("YYYY-MM-DD");
    const t=normalizeTime(tRaw); if(!t) continue;
    if(!out[key]) out[key]={}; out[key][t]=mapStatus(s);
  }
  return out;
}

/* ===== Fetch Sheet ===== */
async function fetchSheet(){
  syncBadge.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶"; syncBadge.className="px-2 py-1 rounded bg-yellow-100 text-yellow-800";
  try{
    const r=await fetch(SHEET_GVIZ_JSON+"&ts="+Date.now(),{cache:"no-store"});
    if(!r.ok) throw new Error("GVIZ "+r.status);
    availability=parseGviz(await r.text());
    syncBadge.textContent="‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (gviz) "+dayjs().format("HH:mm");
    syncBadge.className="px-2 py-1 rounded bg-green-100 text-green-800";
  }catch(e1){
    console.warn("GVIZ fail ‚Üí CSV",e1);
    try{
      const r2=await fetch(SHEET_CSV_URL+"&ts="+Date.now(),{cache:"no-store"});
      if(!r2.ok) throw new Error("CSV "+r2.status);
      availability=parseCsv(await r2.text());
      syncBadge.textContent="‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (csv) "+dayjs().format("HH:mm");
      syncBadge.className="px-2 py-1 rounded bg-green-100 text-green-800";
    }catch(e2){
      console.error("‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ï‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:",e2);
      syncBadge.textContent="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      syncBadge.className="px-2 py-1 rounded bg-red-100 text-red-800";
      availability={};
    }
  }
}

/* ===== UI Calendar ===== */
function getDayStatus(dateStr){
  const daySlots=availability[dateStr]||{};
  let free=0, full=0, closed=false;
  for(const t of TIME_SLOTS){
    const v=(daySlots[t]??"‡∏ß‡πà‡∏≤‡∏á");
    if(v==="‡∏õ‡∏¥‡∏î"){closed=true;break;}
    if(v==="‡πÄ‡∏ï‡πá‡∏°") full++; else free++;
  }
  if(closed) return "gray";
  if(free===0) return "red";
  if(full===0) return "green";
  return "yellow";
}
function renderCalendar(){
  document.getElementById("monthTitle").textContent=monthTitle(visibleMonth);
  const start=visibleMonth.startOf("month").startOf("week");
  const end=visibleMonth.endOf("month").endOf("week");
  const grid=document.getElementById("calendarGrid"); grid.innerHTML="";
  let d=start.clone();
  while(d.isBefore(end)||d.isSame(end,"day")){
    const dateStr=d.format("YYYY-MM-DD");
    const inRange=d.isAfter(START_DATE.subtract(1,"day"))&&d.isBefore(END_DATE.add(1,"day"));
    const isCurMonth=d.month()===visibleMonth.month();
    const status=inRange?getDayStatus(dateStr):"gray";
    const btn=document.createElement("button");
    btn.type="button"; btn.disabled=!inRange||status==="gray";
    btn.className="aspect-square rounded-xl border text-sm flex flex-col items-center justify-center gap-1 "+
      (dateStr===selectedDate?"bg-indigo-50 border-indigo-300":"bg-white hover:bg-gray-50")+
      (!isCurMonth?" opacity-50":"")+(!inRange||status==="gray"?" opacity-40 cursor-not-allowed":"");
    btn.innerHTML=`<div class="leading-none">${d.date()}</div>
      <span class="inline-block w-2.5 h-2.5 rounded-full ${status==='green'?'bg-green-500':status==='yellow'?'bg-yellow-500':status==='red'?'bg-red-500':'bg-gray-400'}"></span>`;
    btn.addEventListener("click",()=>{ if(btn.disabled) return; selectedDate=dateStr; selectedTime=null; showTimes(); renderCalendar(); updateStep(2);});
    grid.appendChild(btn);
    d=d.add(1,"day");
  }
}
function showTimes(){
  const box=document.getElementById("timeBox");
  if(!selectedDate){ box.classList.add("hidden"); return; }
  box.classList.remove("hidden");
  document.getElementById("chosenDateLabel").textContent=`(‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayjs(selectedDate).format("DD/MM")}/${buddhistYear(dayjs(selectedDate).year())})`;
  const grid=document.getElementById("timeGrid"); grid.innerHTML="";
  const daySlots=availability[selectedDate]||{};
  TIME_SLOTS.forEach(t=>{
    const v=(daySlots[t]??"‡∏ß‡πà‡∏≤‡∏á"), taken=(v==="‡πÄ‡∏ï‡πá‡∏°")||(v==="‡∏õ‡∏¥‡∏î");
    const btn=document.createElement("button");
    btn.type="button"; btn.textContent=t; btn.disabled=taken;
    btn.className="py-3 rounded-xl border text-sm font-medium "+(taken?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-indigo-50");
    btn.addEventListener("click",()=>{[...grid.children].forEach(el=>el.classList.remove("slot-active")); btn.classList.add("slot-active"); selectedTime=t; updateStep(2);});
    grid.appendChild(btn);
  });
}

/* ===== Steps & actions ===== */
function updateStep(step){
  for(let i=1;i<=5;i++){
    const li=document.getElementById(`step${i}`);
    if(i<step) li.className="flex items-start gap-2 text-green-700";
    else if(i===step) li.className="flex items-start gap-2";
    else li.className="flex items-start gap-2 text-gray-600";
  }
  document.getElementById("formCustomer").classList.toggle("hidden",step!==2);
  document.getElementById("formPets").classList.toggle("hidden",step!==3);
  document.getElementById("formTerms").classList.toggle("hidden",step!==4);
  document.getElementById("formPay").classList.toggle("hidden",step!==5);
}
document.getElementById("toPets").addEventListener("click",()=>{
  const name=document.getElementById("custName").value.trim();
  const phone=document.getElementById("custPhone").value.trim();
  if(!selectedDate||!selectedTime) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å");
  if(!name||!phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
  if(pets.length===0) addPetForm();
  updateStep(3);
});
document.getElementById("addPet").addEventListener("click",()=>{
  if(pets.length>=3) return alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ï‡∏±‡∏ß");
  addPetForm();
});
function addPetForm(){
  const idx=pets.length+1;
  const wrap=document.createElement("div");
  wrap.className="p-3 border rounded-xl";
  wrap.innerHTML=`
    <div class="text-sm font-medium mb-2">‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà ${idx}</div>
    <div class="grid gap-2">
      <label class="text-xs text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á *</label>
      <input class="border rounded-xl p-2" data-role="petName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏∏‡πã‡∏á‡∏≠‡∏∏‡πã‡∏á" />
      <label class="text-xs text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó *</label>
      <select class="border rounded-xl p-2" data-role="petType">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
        <option>‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option><option>‡πÅ‡∏°‡∏ß</option><option>‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>
      <label class="text-xs text-gray-600">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
      <input class="border rounded-xl p-2" data-role="breed" placeholder="‡πÄ‡∏ä‡πà‡∏ô Poodle / Scottish Fold" />
      <label class="text-xs text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ *</label>
      <select class="border rounded-xl p-2" data-role="service">
        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
        <option>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥</option><option>‡∏ï‡∏±‡∏î‡∏Ç‡∏ô</option><option>‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ç‡∏ô</option><option>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
      </select>
      <label class="text-xs text-gray-600">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á</label>
      <textarea class="border rounded-xl p-2 min-h-[70px]" data-role="notes" placeholder="‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏£‡∏≤‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡πâ‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏ß ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß ‡∏Ø‡∏•‡∏Ø"></textarea>
    </div>`;
  document.getElementById("petsContainer").appendChild(wrap);
  pets.push(wrap);
}
document.getElementById("toTerms").addEventListener("click",()=>{
  if(pets.length===0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß");
  let ok=false;
  for(const wrap of pets){
    const petName=wrap.querySelector('[data-role="petName"]').value.trim();
    const petType=wrap.querySelector('[data-role="petType"]').value.trim();
    const service=wrap.querySelector('[data-role="service"]').value.trim();
    if(!petName && !petType && !service) continue;
    if(!petName || !petType || !service) return alert("‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß");
    ok=true;
  }
  if(!ok) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß");
  updateStep(4);
});
document.getElementById("agree").addEventListener("change",e=>{
  document.getElementById("toPayment").disabled=!e.target.checked;
});
document.getElementById("toPayment").addEventListener("click",()=>updateStep(5));

/* ===== Deep link to LINE OA with summary ===== */
document.getElementById("goLine").addEventListener("click",()=>{
  const name=document.getElementById("custName").value.trim();
  const phone=document.getElementById("custPhone").value.trim();
  if(!selectedDate||!selectedTime) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤");
  if(!name||!phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2");

  // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á
  const petLines=[];
  pets.forEach((wrap,i)=>{
    const n=wrap.querySelector('[data-role="petName"]').value.trim();
    const t=wrap.querySelector('[data-role="petType"]').value.trim();
    const s=wrap.querySelector('[data-role="service"]').value.trim();
    const b=wrap.querySelector('[data-role="breed"]').value.trim();
    const note=wrap.querySelector('[data-role="notes"]').value.trim();
    if(n||t||s){
      petLines.push(`${i+1}. ${n||"-"} / ${t||"-"} / ${s||"-"}${b?` (${b})`:""}${note?` ‚Äî ${note}`:""}`);
    }
  });

  const dateLabel=`${dayjs(selectedDate).format("DD/MM")}/${buddhistYear(dayjs(selectedDate).year())}`;
  const msg=[
    "üìå ‡πÅ‡∏à‡πâ‡∏á‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö",
    `‚Ä¢ ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: ${dateLabel} ‡πÄ‡∏ß‡∏•‡∏≤ ${selectedTime} ‡∏ô.`,
    `‚Ä¢ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${name}`,
    `‚Ä¢ ‡πÇ‡∏ó‡∏£: ${phone}`,
    (petLines.length?`‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á:\n   - ${petLines.join("\n   - ")}`:"‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡πâ‡∏≠‡∏á: -"),
    "‚Äî ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß PO Grooming ‚Äî"
  ].join("\n");

  const url=`https://line.me/R/oaMessage/${encodeURIComponent(LINE_OA_ID)}/?text=${encodeURIComponent(msg)}`;
  window.location.href=url;
});

/* ===== Nav & boot ===== */
document.getElementById("prevMonth").addEventListener("click",()=>{const prev=visibleMonth.subtract(1,"month"); if(prev.isBefore(START_DATE,"month"))return; visibleMonth=prev; renderCalendar();});
document.getElementById("nextMonth").addEventListener("click",()=>{const next=visibleMonth.add(1,"month"); if(next.isAfter(END_DATE,"month"))return; visibleMonth=next; renderCalendar();});
document.getElementById("btnReload").addEventListener("click",async()=>{await fetchSheet(); renderCalendar(); if(selectedDate) showTimes();});

(async function init(){ await fetchSheet(); renderCalendar(); })();
</script>
</body>
</html>


